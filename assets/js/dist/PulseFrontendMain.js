!function(){"use strict";angular.module("ApiModule",["CRMHTTPModule","ui.router","ErrorHandler","Validation"]).service("ApiService",["CRMHTTPService","$state","errorHandlerService","CheckSum",function(a,b,c,d){var e=function(a){a.content=a.content||{},a.content.data=a.content.data||{},a.content.data.colleagues=a.content.data.colleagues||"";try{return void(localStorage.colleagues=JSON.stringify(a.content.data.colleagues))}catch(a){throw new Error(a)}};this.processCustomer=function(a,c){return b.go(a,{appl_id:c.id||""})},this.init=function(b,c){return new Promise(function(d,e){return a.getData("/"+b+"_init",{appl_id:c||""}).then(function(a){return d(a.content)},function(a){return e(a)})})},this.authenticate=function(b){var c=this;return new Promise(function(d,f){return a.postData("/authenticate",b).then(function(b){return a.setToken(b).then(function(){return c.getEnvironment().then(function(a){return e(a),d()})},function(a){return f(a)})}).error(function(a){return a=a||new Error("Unknown Error, server may be unreachable"),f(a)})})},this.getEnvironment=function(){return new Promise(function(b,c){return a.getEnvironment().then(function(a){return b(a)},function(a){return c(a)})})},this.getPerformanceData=function(){var b=new Date,c=b.getDate(),d=b.getMonth()+1,e=b.getFullYear();c<10&&(c="0"+c),d<10&&(d="0"+d);var b=e+"-"+d+"-"+c;return console.log(b),new Promise(function(b,c){return a.getData("/pulse_performance").then(function(a){return console.log(a),b(a)},function(a){return c(a)})})},this.getCustomerApplication=function(b){return new Promise(function(c,d){return a.getData("application",{unique_customer_id:b}).then(function(a){return c(a)},function(a){return d(a)})})},this.postCustomerApplication=function(b,c){return new Promise(function(d,e){return a.postData("application",{identifiers:b,changes:c}).then(function(a){return console.log(a),d(a)},function(a){return e(a)})})},this.mark_action=function(b){return new Promise(function(c,d){return a.postData("mark_action",{action_id:b.action_id,state:"Done"}).then(function(a){return c(a)},function(a){return d(a)})})},this.getCustomerApplications=function(b,c,d){return new Promise(function(e,f){return a.getData(b,{search:c,byshop:d}).then(function(a){return a.content=a.content||{},a.content.data=a.content.data||{},e(a.content.data)},function(a){return f(a)})})},this.getCustomerList=function(a,b,c,d){var e=this;return new Promise(function(f,g){return d=c?"1":"0",e.getCustomerApplications(b,a,d).then(function(a){try{a=a||[],a.length||(a=[])}catch(a){return g(a)}return f(a)},function(a){return g(a)})})},this.query=function(a,b,c){return new Promise(function(d,e){if(parseInt(a)){if(a.toString().length>5)var f=b.filter(function(b,c){if(b.phone.toString().indexOf(a.toString())!==-1)return b});else var f=b.filter(function(b,c){if(b.customer_id.toString().indexOf(a.toString())!==-1)return b});return d(f)}try{var f=b.filter(function(b,d){if(b.name=b.name||"",b[c].toString().toUpperCase().indexOf(a.toString().toUpperCase())!==-1)return b});return d(f)}catch(a){return e(a)}})};var f=function(a){var b;try{b=new Date(a).toISOString().toUpperCase()}catch(a){throw a}return b};this.submitForm=function(c,e){return document.getElementById("loading").style.display="block",new Promise(function(g,h){try{if(Object.keys(e).forEach(function(a){"object"==typeof e[a]&&e[a].value&&(e[a]=e[a].value),a.indexOf("date")!==-1&&("date_picker"!==a?e[a]=f(e[a]):"date_picker"===a&&delete e[a])}),1==e.successful?Object.keys(e).forEach(function(a){a.indexOf("reason_for_failed_")!==-1&&delete e[a]}):Object.keys(e).forEach(function(a){a.indexOf("serial_number")!==-1&&delete e[a]}),e.serial_number&&!d.crc_check(String(e.serial_number)))return document.getElementById("loading").style.display="none",h("Serial number failed validation: "+e.serial_number);Object.keys(e).forEach(function(a){a.indexOf("serial_number")!==-1||a.indexOf("products")!==-1||(a.indexOf("appl_id")!==-1?e[a]=parseInt(e[a]):"boolean"!=typeof e[a]&&(e[a]=e[a].toString()))})}catch(a){return document.getElementById("loading").style.display="none",h(a)}return a.postData(c,e).then(function(a){return b.go("index"),g(a)},function(a){return document.getElementById("loading").style.display="none",h(a)})})}}])}(),function(){"use strict";angular.module("authenticationModule",["ErrorHandlerModule","ApiModule","ui.router"]).service("loginService",["$http","$timeout","errorHandlerService","HTTPService","ApiService",function(a,b,c,d){this.submit=function(a,b){var c=function(){document.getElementById("loading").style.display="block"},e=function(){document.getElementById("loading").style.display="none"};return new Promise(function(f,g){return c(),d.authenticate({username:a,password:b}).then(function(){return e(),console.log("logged in"),f()}).error(function(a){return e(),console.log("couldnt log in"),a=a||new Error("Unknown Error, Server May be Unreachabled"),g(a)})}).fail(!1)}}])}(function(){"use strict";angular.module("Validation",[]).service("CheckSum",[function(){var a="0123456789ABCDEFGHIJKLMNPQRSTUVWXYZ";this.makeCRCTable=function(){for(var a,b=[],c=0;c<256;c++){a=c;for(var d=0;d<8;d++)a=1&a?3988292384^a>>>1:a>>>1;b[c]=a}return b},this.crc32=function(a){for(var b=window.crcTable||(window.crcTable=this.makeCRCTable()),c=-1,d=0;d<a.length;d++)c=c>>>8^b[255&(c^a.charCodeAt(d))];return(c^-1)>>>0},this.crc_encode=function(b){b=String(b);var c=this.crc32(b)%a.length;return b+a[c]},this.crc_check=function(a){return a=String(a),a=a.toUpperCase(),"C"!==a.charAt(0)||"U"!==a.charAt(1)?"B"===a.charAt(0)&&"B"===a.charAt(1):a==this.crc_encode(a.slice(0,a.length-1))}}])})(),function(){"use strict";angular.module("ErrorHandler",[]).service("errorHandlerService",function(){this.checkHTTPError=function(a){var b=this;return new Promise(function(c,d){if(!a)return d(new Error("Server cannot be found or no valid response detected"));if(!a.content&&!a.request_status)return d(new Error("Invalid data returned by server"));if(a.content=a.content||{},a.request_status){if(null===a.request_status||"4"===a.request_status.toString().charAt(0)||"5"===a.request_status.toString().charAt(0))return a.content.field_errors&&b.checkFormSubmissionErrors(a),"Invalid Credentials"==a.request_msg.toString()?(a.request_msg="Incorrect username or password",d(new Error(" "+a.request_msg+"<br/> Visit <a href='https://user.bboxx.co.uk' target='_blank'>user.bboxx.co.uk</a>"))):d(new Error("Error: "+a.request_status+" "+a.request_msg));a.content.field_errors&&b.checkFormSubmissionErrors(a)}return c(a)})},this.checkFormSubmissionErrors=function(a){if(!a.content)return new Error("Invalid data returned by server");if(a.content){var b=a.content.field_errors,c=document.getElementsByClassName("validation-failure");Object.keys(c).forEach(function(a){"undefined"!=typeof c[a]&&$(c[a]).removeClass("validation-failure")});document.getElementsByClassName("validation-failure-message");return $(".validation-failure-message").remove(),Object.keys(b).forEach(function(c){try{if(document.getElementById(c)&&document.getElementById(c).className.indexOf("validation-failure")==-1){document.getElementById(c).className+=" validation-failure";var d=document.createElement("div");d.innerHTML=d.innerHTML+b[c],$(d).addClass(" validation-failure-message"),d.id="validation_"+c,document.getElementById(c).insertAdjacentElement("afterend",d)}}catch(b){return a}}),new Error(a.message||a.msg||"Form failed validation checks, please check the marked fields")}return a}})}(),function(){"use strict";var a;a="http:"!==location.protocol?location.protocol+"//"+location.hostname+"/api":"https://testpulse1.bboxx.co.uk/api",angular.module("CRMHTTPModule",["ui.router","ErrorHandler"]).constant("constants",{API:a,PORT:"80"}).service("CRMHTTPService",["$http","constants","$state","errorHandlerService",function(a,b,c,d){var e=null,f=null,g=function(){try{e=localStorage.token||null,f=localStorage.exp_date||null}catch(a){e=null,f=null}return{token:e,exp_date:f}};this.setToken=function(a){return a.content=a.content||{},a.content.data=a.content.data||{},new Promise(function(b,c){try{return localStorage.token=a.content.data.token,a.content.exp_date instanceof Date?localStorage.exp_date=a.content.data.exp_date.toISOString():localStorage.exp_date=a.content.data.exp_date,localStorage.company=a.content.data.company,localStorage.email=a.content.data.email,a.content.data.shops.length&&(localStorage.shops=a.content.data.shops),localStorage.name=a.content.data.name,localStorage.last_login=a.content.data.last_login,localStorage.groups=a.content.data.groups||[],localStorage.main_role=a.content.data.main_role||"",localStorage.org_name=a.content.data.ou_name||"",localStorage.org_type=a.content.data.ou_type||"",localStorage.technicians=JSON.stringify(a.content.data.technicians)||[],localStorage.shopmanager_code=a.content.data.code,localStorage.shopmanager_id=a.content.data.id,b()}catch(a){return console.error(a),c(a)}})},this.getEnvironment=function(){var a=this;return new Promise(function(b,c){return a.getData("get_env",null).then(function(a){return b(a)},function(a){return c(a)})})},this.getData=function(a,c){var d=this,e=g();c||(c={}),"/"!==a.charAt(0)&&(a="/"+a);var f={method:"GET",url:b.API+a,params:c,headers:{"X-Auth-Token":e.token},timeout:31e4};return new Promise(function(a,b){return d.submitToApi(f,e).then(function(b){return a(b)},function(a){return b(a)})})},this.postData=function(a,c){var d=this,e=g();c||(c={}),"/"!==a.charAt(0)&&(a="/"+a);var f={method:"POST",url:b.API+a,data:c,headers:{"X-Auth-Token":e.token},timeout:31e4};return new Promise(function(a,b){return d.submitToApi(f,e).then(function(b){return a(b)},function(a){return b(a)})})},this.submitToApi=function(b,c){return new Promise(function(e,f){return h(b.url,c).then(function(c){return localStorage.testing?_checkMock(b).then(function(a){return e(a)}):void a(b).success(function(a){return d.checkHTTPError(a).then(function(a){return e(a)},function(a){return f(a)})}).error(function(a){return null===a&&(a=new Error("The server may not be reachable")),f(a)})},function(a){return f(a||"Token expired")})})},this.checkToken=function(){return h("/",g())};var h=function(a,b){var d={msg:"Token Expired",message:"Token Expired, Please login again",status:401,content:null};return a.indexOf("/authenticate")!==-1?Promise.resolve():location.href.indexOf("login")!==-1?Promise.resolve():new Promise(function(a,e){if(!b.token)return a(c.go("login"));var f=new Date,g=new Date(f.getUTCFullYear(),f.getUTCMonth(),f.getUTCDate(),f.getUTCHours(),f.getUTCMinutes(),f.getUTCSeconds());return new Date(b.exp_date)<=new Date(g)?(c.go("logged_out",{error:d.message}),a()):a()})}}])}(),function(){"use strict";String.prototype.htmlEncode=function(){return String(this).replace(/&/g,"&amp;").replace(/"/g,"&quot;").replace(/'/g,"&#39;").replace(/</g,"&lt;").replace(/>/g,"&gt;")},Promise.prototype.error=Promise.prototype.catch,Promise.prototype.success=function(a){return this.then(function(b){return new Promise(function(c){if(bootbox.alert((b||{}).message||"Success",c),"string"==typeof a)return window.location.pathname="/"})})},Promise.prototype.fail=function(a,b,c){return this.catch(function(b){var c=null;if(b instanceof Error&&a&&(c=b.stack),"string"!=typeof b&&b&&(b=b instanceof Error?b.message:b.name||b.message||b.text||b.error),"string"!=typeof b)try{b="Unknown Error : "+JSON.stringify(b)}catch(a){}var d="<i class='fa fa-warning' style='color:red'></i>&nbsp;<b>ERROR:"+(b||"Unknown Error")+"</b><br><br>Technical Details (for the IT Support, please include it if you ask for support):<br><pre style='font-size:8px'>\n[+] Error: "+(b||"Unknown Error")+"\n"+(b.name?"[+] Name: "+b.name:"\n")+"[+] Stack: "+(c||(new Error).stack.replace("Error","")).htmlEncode()+"\n\n[+] URL: "+window.location.toString()+"\n[+] Date: "+(new Date).toISOString()+"\n[+] User-Agent: "+navigator.userAgent+"\n</pre>";a&&(d="<i class='fa fa-warning' style='color:red'></i>&nbsp;<b>ERROR:"+(b||"Unknown Error")+"</b><br><br>Technical Details (for the IT Support, please include it if you ask for support):<br><pre style='font-size:8px'>\n[+] Error: "+(b||"Unknown Error")+"\n"+(b.name?"[+] Name: "+b.name:"\n")+"[+] Stack: "+(c||(new Error).stack.replace("Error","")).htmlEncode()+"\n\n[+] URL: "+window.location.toString()+"\n[+] Date: "+(new Date).toISOString()+"\n[+] User-Agent: "+navigator.userAgent+"\n</pre>"),bootbox.alert({message:d,className:"error-modal"})})}}(),function(){"use strict";angular.module("ui-elements",[]).service("UIElements",["$location","$timeout","$rootScope",function(a,b,c){this.successPopup=function(a){return"function"!=typeof a&&(a=function(){}),bootbox.alert({message:"SUCCESS",callback:function(){b(function(){c.$apply()}),a()}})},this.areYouSurePopup=function(a){"function"!=typeof a&&(a=function(){}),bootbox.dialog({message:"Are you really sure?",title:"Are you really sure?",buttons:{cancel:{label:"CANCEL",className:"btn-default"},yes:{label:"YES",className:"btn-secondary click-once",callback:function(){document.getElementsByClassName("click-once")[0].style["pointer-events"]="none",a()}}}})}}])}(),function(){"use strict";angular.module("LoginModule",["ErrorHandlerModule","HTTPModule","ApiModule","ngMessages","ui.router"]).controller("loginCtrl",["$scope","$sce","$http","$timeout","$q","errorHandlerService","constants","HTTPService","ApiService","$state",function(a,b,c,d,e,f,g,h,i,j){a.emailHTML=b.trustAsHtml("Enter your BBOXX email address, it should end in <b>@bboxx.co.uk </b>"),a.hideMenu=!0;var k=function(a){return location.href="/"};a.submitLogin=function(){var b=(document.getElementById("progressCallback").getAttribute("value"),function(){document.getElementById("loading").style.display="block",document.getElementById("progressCallback").setAttribute("value","Logging in..."),document.getElementById("progressCallback").style["pointer-events"]="none"}),c=function(){document.getElementById("loading").style.display="none",document.getElementById("progressCallback").setAttribute("value","Login"),document.getElementById("progressCallback").style["pointer-events"]=""};return new Promise(function(d,e){return b(),i.authenticate({username:a.login.email,password:a.login.password}).then(function(){return c(),d(k(localStorage.main_role))}).error(function(a){return c(),a=a||new Error("Unknown Error, server may be unreachable"),e(a)})}).fail(!1)},a.showPassword=function(){};var l=document.getElementById("password"),m=document.getElementById("passCapsLock");l.addEventListener("keypress",function(a){var b=String.fromCharCode(a.which);b.toUpperCase()!==b||b.toLowerCase()===b||a.shiftKey?m.style.visibility="hidden":m.style.visibility="visible"})}])}();var PulseApp=angular.module("PulseFE",["ngMessages","ui.bootstrap","ui.router","ErrorHandler","CRMHTTPModule","ApiModule","ui.grid","LoginModule","ui.grid.pagination"]);